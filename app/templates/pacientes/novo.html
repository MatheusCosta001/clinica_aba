{% extends "base.html" %}
{% block title %}Novo Paciente{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow p-4 mx-auto" style="max-width: 700px; background-color: #f8faff; border: 1px solid #e3e6f0;">
    <h3 class="text-center mb-4 text-primary">
      {% if paciente %}Editar{% else %}Novo{% endif %} Paciente
    </h3>
    <form method="post">
      <div class="row">
        <div class="col-md-12 mb-3">
          <label class="form-label fw-semibold">Nome</label>
          <input type="text" name="nome" class="form-control" value="{{ paciente.nome if paciente else '' }}" required>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Data de Nascimento</label>
          <input type="date" name="dataNascimento" class="form-control" value="{{ paciente.dataNascimento if paciente and paciente.dataNascimento else '' }}">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Diagnóstico</label>
          <input type="text" name="diagnostico" class="form-control" value="{{ paciente.diagnostico if paciente else '' }}">
        </div>
        <div class="col-md-12 mb-3">
          <label class="form-label fw-semibold">Responsável</label>
          <input type="text" name="responsavel" class="form-control" value="{{ paciente.responsavel if paciente else '' }}">
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">CEP</label>
          <input type="text" id="cep" name="cep" maxlength="9" class="form-control" value="{{ paciente.cep if paciente else '' }}">
        </div>
        <div class="col-md-8 mb-3">
          <label class="form-label fw-semibold">Rua</label>
          <input type="text" id="rua" name="rua" class="form-control" value="{{ paciente.rua if paciente else '' }}">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Bairro</label>
          <input type="text" id="bairro" name="bairro" class="form-control" value="{{ paciente.bairro if paciente else '' }}">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">Cidade</label>
          <input type="text" id="cidade" name="cidade" class="form-control" value="{{ paciente.cidade if paciente else '' }}">
        </div>
        <div class="col-md-2 mb-3">
          <label class="form-label fw-semibold">UF</label>
          <input type="text" id="uf" name="uf" class="form-control" value="{{ paciente.uf if paciente else '' }}">
        </div>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('pacientes.index') }}" class="btn btn-outline-secondary btn-cancel">Cancelar</a>
        <button type="submit" class="btn btn-primary px-4">Salvar</button>
      </div>

    </form>
  </div>
</div>

<script>
  const cepInput = document.getElementById("cep");

  cepInput.addEventListener("input", function() {
    let cep = this.value.replace(/\D/g, '');
    if (cep.length > 5) {
      this.value = cep.substring(0, 5) + '-' + cep.substring(5, 8);
    } else {
      this.value = cep;
    }
  });

  cepInput.addEventListener("blur", function() {
    let cep = this.value.replace(/\D/g, '');
    if (cep.length !== 8) return;

    fetch(`https://viacep.com.br/ws/${cep}/json/`)
      .then(response => response.json())
      .then(data => {
        if (!("erro" in data)) {
          document.getElementById("rua").value = data.logradouro;
          document.getElementById("bairro").value = data.bairro;
          document.getElementById("cidade").value = data.localidade;
          document.getElementById("uf").value = data.uf;
        }
      })
      .catch(() => console.log("Erro ao buscar o CEP."));
  });
</script>
{% endblock %}
